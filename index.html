<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vishva Hindu Parishad Australia Inc.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .html5-qrcode-element { color: #fff; }
        #reader {
            height: 60vh;
        }
        #scanner {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

<nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b px-4 py-3 flex justify-between items-center">
    <span class="font-bold text-indigo-600 text-xl tracking-tight">ClassPass</span>
    <div id="user-badge" class="hidden px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-semibold">Teacher</div>
</nav>

<main id="app-container" class="max-w-md mx-auto p-4 mb-24">
</main>

<div id="bottom-nav" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t safe-area-bottom flex justify-around p-3 z-50">
    <button onclick="router.navigate('scanner')" class="flex flex-col items-center text-slate-400 nav-link" id="nav-dashboard">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h7"></path></svg>
        <span class="text-[10px] mt-1">Scan</span>
    </button>
</div>

<template id="tpl-home">
    <div class="space-y-6 mt-8">
        <div class="text-center">
            <h2 class="text-3xl font-extrabold text-slate-800">Welcome.</h2>
            <p class="text-slate-500 mt-2">Community service starts here.</p>
        </div>
        <div class="space-y-3">
            <button onclick="handleTeacherEntry()" class="w-full bg-white border border-slate-200 p-4 rounded-2xl shadow-sm flex items-center justify-between hover:bg-slate-50 transition">
                <div class="flex items-center">
                    <div class="bg-indigo-100 p-3 rounded-xl mr-4 text-indigo-600">üë§</div>
                    <div class="text-left"><p class="font-bold">Volunteer Teacher</p><p class="text-xs text-slate-400">Scanner & Dashboard</p></div>
                </div>
                <span>‚Üí</span>
            </button>
            <button onclick="router.navigate('parent-lookup')" class="w-full bg-white border border-slate-200 p-4 rounded-2xl shadow-sm flex items-center justify-between hover:bg-slate-50 transition">
                <div class="flex items-center">
                    <div class="bg-emerald-100 p-3 rounded-xl mr-4 text-emerald-600">üë™</div>
                    <div class="text-left"><p class="font-bold">Parent Portal</p><p class="text-xs text-slate-400">View Student Passes</p></div>
                </div>
                <span>‚Üí</span>
            </button>
        </div>
    </div>
</template>

<template id="tpl-dashboard">
    <div class="space-y-4">
        <div class="flex justify-between items-end">
            <div>
                <h2 class="text-2xl font-bold">Activity</h2>
                <p class="text-slate-500 text-sm">Real-time check-ins</p>
            </div>
            <button onclick="loadAttendance()" class="text-indigo-600 text-sm font-semibold">Refresh</button>
        </div>

        <div id="attendance-list" class="space-y-3">
        </div>
    </div>
</template>

<template id="tpl-scanner">
    <div class="space-y-4">
        <h2 class="text-2xl font-bold">Scanner</h2>
        <div id="reader" class="overflow-hidden rounded-3xl border-4 border-white shadow-xl bg-black"></div>
        <button id="toggle-camera" class="mb-2 bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold" onclick="toggleCamera()">
            Switch Camera
        </button>
        <div id="scan-feedback" class="text-center p-4 rounded-2xl bg-slate-100 text-slate-600 font-medium">
            Point camera at student QR
        </div>
    </div>
</template>

<template id="tpl-parent-lookup">
    <div class="space-y-6">
        <button onclick="router.navigate('home')" class="text-slate-400 text-sm">‚Üê Back</button>
        <h2 class="text-2xl font-bold">Parent Access</h2>
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
            <label class="block text-xs font-semibold text-slate-400 uppercase mb2">Phone Number</label>
            <input type="tel" id="lookup-phone" placeholder="0400 000 000" class="w-full text-lg p-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
            <button onclick="performParentLookup()" class="w-full mt-4 bg-indigo-600 text-white p-4 rounded-xl font-bold shadow-indigo-200 shadow-lg">
                View My Child's Pass
            </button>
        </div>
    </div>
</template>

<template id="tpl-parent-hub">
    <div class="space-y-6 pb-20">
        <button onclick="router.navigate('home')" class="text-slate-400 text-sm">‚Üê Back</button>
        <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold">My Children</h2>
            <span id="child-count" class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">0</span>
        </div>

        <div id="passes-container" class="space-y-8">
        </div>
    </div>
</template>

<template id="tpl-student">
    <div class="space-y-6">

        <div class="bg-white rounded-[2rem] shadow-2xl overflow-hidden border border-slate-100">
            <div class="bg-indigo-600 p-8 text-center">
                <div class="w-20 h-20 bg-white/20 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl">
                    üéì
                </div>
                <h2 id="pass-name" class="text-2xl font-bold text-white tracking-tight">Loading...</h2>
                <p class="text-indigo-100 text-xs uppercase tracking-widest mt-1">Official Student Pass</p>
            </div>

            <div class="p-10 flex flex-col items-center justify-center space-y-6">
                <div class="p-4 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                    <canvas class="pass-qr rounded-xl" data-student-id=""></canvas>
                </div>
                <p class="text-slate-400 text-[10px] text-center max-w-[180px]">
                    Present this code to the volunteer at the classroom door for check-in.
                </p>
            </div>
        </div>
    </div>
</template>

<script>
    // CONFIG
    const SECRET_PIN = "2011"
    const API_URL = 'https://wnoghxzxbwnvqbujimwh.supabase.co'
    const API_TOKEN = 'sb_publishable_lhSV1V_m-5eyLKtf6zeZzw_y_ME9rMc'
    let html5Scanner = null;
    const supabaseClient = supabase.createClient(API_URL, API_TOKEN);

    // Initialize first screen
    window.onload = () => router.navigate('home');

    function handleTeacherEntry() {
        const pin = prompt("Teacher Access PIN:");
        if(pin === SECRET_PIN) router.navigate('dashboard');
    }

    // --- ROUTER ENGINE ---
    const router = {
        current: 'home',
        navigate(screen) {
            this.current = screen;
            const container = document.getElementById('app-container');
            const tpl = document.getElementById(`tpl-${screen}`);

            // Clear and Inject
            container.innerHTML = '';
            if (tpl) container.appendChild(tpl.content.cloneNode(true));

            // Toggle UI Elements
            document.getElementById('bottom-nav').style.display = (screen === 'dashboard' || screen === 'scanner') ? 'flex' : 'none';
            document.getElementById('user-badge').style.display = (screen === 'dashboard' || screen === 'scanner') ? 'block' : 'none';

            // Additional init logic based on screen
           // if(screen === 'dashboard') loadLiveDashboard();

            if (screen === 'scanner') startScanner();

        }
    };

    // --- DASHBOARD LOGIC ---
    async function loadAttendance() {
        const list = document.getElementById('attendance-list');
        if (!list) return;

        const { data, error } = await supabaseClient
            .from('attendance')
            .select('created_at, students(name)')
            .order('created_at', { ascending: false })
            .limit(20);

        if (data) {
            list.innerHTML = data.map(entry => `
            <div class="glass-card p-4 rounded-2xl flex justify-between items-center animate-in fade-in slide-in-from-bottom-2 duration-500">
                <div>
                    <p class="font-bold text-slate-800">${entry.students.name}</p>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest">${new Date(entry.created_at).toLocaleTimeString()}</p>
                </div>
                <div class="bg-emerald-100 text-emerald-600 p-2 rounded-full">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293a1 1 0 0.11.414 0z" clip-rule="evenodd"></path></svg>
                 </div>
            </div>
            `).join('');
        }
    }

    // SETUP REAL-TIME SUBSCRIPTION
    supabaseClient
        .channel('public:attendance')
        .on('postgres_changes', { event: 'INSERT', table: 'attendance' }, () => {
            if (router.current === 'dashboard') loadAttendance();
        })
        .subscribe();

    const video = document.createElement('video');
    let cameraMode = 'environment';
    function startScanner(mode = cameraMode) {
        cameraMode = mode;
        document.getElementById('scan-feedback').innerHTML = 'Point camera at student QR';
        // Remove previous video element if exists
        if (video.parentNode) video.parentNode.removeChild(video);
        video.srcObject && video.srcObject.getTracks().forEach(track => track.stop());
        video.setAttribute('playsinline', true);
        document.getElementById('reader').appendChild(video);

        navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: cameraMode,
            }
        }).then(stream => {
            video.srcObject = stream;
            video.play();
            requestAnimationFrame(() => tick());
        });
    }

    function toggleCamera() {
        cameraMode = cameraMode === 'user' ? 'environment' : 'user';
        startScanner(cameraMode);
    }

    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    let scanCooldown = false;
    let cleanPhone = '';

    async function tick() {
        if (scanCooldown) {
            requestAnimationFrame(tick);
            return;
        }

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
                scanCooldown = true;
                // Split QR code data
                const [studentId, scannedPhone] = code.data.split('|');
                // Lookup student by ID
                const {data, error} = await supabaseClient
                    .from('students')
                    .select('name')
                    .eq('id', studentId)
                    .single();
                if (data && data.name) {
                    // Get parent phone from student record
                    // Insert attendance record with parent phone
                    const {error: insertError} = await supabaseClient
                        .from('attendance')
                        .insert([{student_id: studentId, scanned_phone: scannedPhone}]);
                    if (!insertError) {
                        document.getElementById('scan-feedback').innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="bg-emerald-100 rounded-full p-2">
                                <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                            <div class="text-lg font-bold text-emerald-700">Checked in: ${data.name}</div>
                        </div>
                        `;
                    } else {
                        document.getElementById('scan-feedback').innerHTML = `
                            <div class="text-red-600 font-bold">Attendance not recorded</div>
                        `;
                    }
                } else {
                    document.getElementById('scan-feedback').innerHTML = `
                        <div class="text-red-600 font-bold">Student not found</div>
                    `;
                }
                // Wait 2 seconds, then allow next scan
                setTimeout(() => {
                    document.getElementById('scan-feedback').innerHTML = `Point camera at student QR`;
                    scanCooldown = false;
                }, 2000);
            }
        }
        requestAnimationFrame(tick);
    }

    // --- PARENT LOOKUP LOGIC ---
    async function performParentLookup() {
        const phone = document.getElementById('lookup-phone').value;
        cleanPhone = phone.replace(/\D/g, ''); // Remove all non-digit characters
        const { data: kids, error } = await supabaseClient
            .from('students')
            .select('*')
            .or(`parent1_phone.eq.${cleanPhone},parent2_phone.eq.${cleanPhone}`);

        if (kids && kids.length > 0) {
            router.navigate('parent-hub');
            renderAllPasses(kids);
        } else {
            alert("No students found with that number.")
        }
    }

    function renderAllPasses(kids) {
        const container = document.getElementById('passes-container');
        document.getElementById('child-count').innerText = kids.length;
        container.innerHTML = '';

        kids.forEach(kid => {
            // 1. Create the Card HTML
            const tpl = document.getElementById('tpl-student');
            const tempDiv = document.createElement('div');
            tempDiv.appendChild(tpl.content.cloneNode(true));
            tempDiv.querySelector('#pass-name').innerText = kid.name;
            tempDiv.querySelector('.pass-qr').setAttribute('data-student-id', kid.id);
            const cardHtml = tempDiv.innerHTML;

            container.innerHTML += cardHtml;

            // 2. Generate the QR for this specific kid
            // We use a slight delay to ensure the HTML is in the DOM
            setTimeout(() => {
                const canvas = document.querySelector(`canvas.pass-qr[data-student-id='${kid.id}']`);
                const qrData = `${kid.id}|${cleanPhone}`
                QRCode.toCanvas(canvas, qrData, {
                    width: 220,
                    margin: 2,
                    color: { dark: '#1e293b', light: '#f8fafc' }
                });
            }, 100);
        });
    }
</script>
</body>
</html>